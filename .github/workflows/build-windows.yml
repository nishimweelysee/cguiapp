name: Build Windows Executable

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MSYS2
        run: |
          choco install msys2 -y
          refreshenv

      - name: Install GTK and Build Tools
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm mingw-w64-x86_64-gtk3 mingw-w64-x86_64-pkg-config mingw-w64-x86_64-gcc make

      - name: Build Application
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          # MSYS2 automatically converts Windows paths, but we need to handle it explicitly
          # Use the workspace environment variable and convert properly
          cd "${{ github.workspace }}"
          # If that doesn't work, try manual conversion
          if [ ! -d src ]; then
            WIN_PATH="${{ github.workspace }}"
            # Convert D:\path\to\dir to /d/path/to/dir
            DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
            PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2 | sed 's/\\/\//g' | sed 's/^\/\///')
            cd "/$DRIVE$PATH_PART"
          fi
          echo "Current directory: $(pwd)"
          echo "Listing files:"
          ls -la
          mkdir -p bin obj data
          export PATH="/mingw64/bin:$PATH"
          echo "Building application..."
          gcc -Wall -Wextra -std=c11 -mwindows \
            -o bin/stock_management.exe \
            $(pkg-config --cflags --libs gtk+-3.0) \
            src/*.c

      - name: Bundle DLLs
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          # Navigate to workspace
          cd "${{ github.workspace }}"
          # If that doesn't work, convert path manually
          if [ ! -d bin ]; then
            WIN_PATH="${{ github.workspace }}"
            DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
            PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2 | sed 's/\\/\//g' | sed 's/^\/\///')
            cd "/$DRIVE$PATH_PART"
          fi
          MSYS2_BIN=/mingw64/bin

          # Copy essential DLLs
          cp $MSYS2_BIN/libgtk-3-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libgdk-3-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libglib-2.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libgobject-2.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libgio-2.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libpango-1.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libcairo-2.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libpangoft2-1.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libpangocairo-1.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libgdk_pixbuf-2.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libatk-1.0-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libepoxy-0.dll bin/ 2>/dev/null || true

          # Copy additional dependencies
          cp $MSYS2_BIN/libintl-8.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libiconv-2.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libwinpthread-1.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libffi-8.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libbz2-1.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libharfbuzz-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libfreetype-6.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libfontconfig-1.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libpng16-16.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libjpeg-8.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libtiff-5.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libpixman-1-0.dll bin/ 2>/dev/null || true
          cp $MSYS2_BIN/libexpat-1.dll bin/ 2>/dev/null || true

          # Copy GTK data files
          if [ -d /mingw64/share/gtk-3.0 ]; then
            mkdir -p bin/share
            cp -r /mingw64/share/gtk-3.0 bin/share/ 2>/dev/null || true
            cp -r /mingw64/share/glib-2.0 bin/share/ 2>/dev/null || true
          fi

          # Create data folder
          mkdir -p bin/data

          # Compile schemas if glib-compile-schemas exists
          if [ -f /mingw64/bin/glib-compile-schemas.exe ] && [ -d bin/share/glib-2.0/schemas ]; then
            /mingw64/bin/glib-compile-schemas.exe bin/share/glib-2.0/schemas 2>/dev/null || true
          fi

      - name: Create Standalone Package
        run: |
          cd bin
          if not exist share mkdir share
          if not exist data mkdir data

      - name: Upload Standalone Package
        uses: actions/upload-artifact@v4
        with:
          name: StockManagement-Windows-Standalone
          path: bin/*
          retention-days: 30

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          refreshenv

      - name: Create Installer
        run: |
          if exist StockManagement_Installer_WithGTK.iss (
            "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" StockManagement_Installer_WithGTK.iss
          ) else if exist StockManagement_Installer.iss (
            "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" StockManagement_Installer.iss
          )

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: StockManagement-Installer
          path: installer/*.exe
          retention-days: 30
          if-no-files-found: warn
