name: Build Windows Executable

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MSYS2
        run: |
          choco install msys2 -y
          refreshenv

      - name: Install GTK and Build Tools (32-bit)
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm mingw-w64-i686-gtk3 mingw-w64-i686-pkg-config mingw-w64-i686-gcc make

      - name: Build Application
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          # Convert Windows path D:\a\cguiapp\cguiapp to /d/a/cguiapp/cguiapp
          WIN_PATH="${{ github.workspace }}"
          # Convert Windows path: D:\a\cguiapp\cguiapp -> /d/a/cguiapp/cguiapp
          # Try cygpath first (most reliable)
          if command -v cygpath &> /dev/null; then
            MSYS_PATH=$(cygpath -u "$WIN_PATH")
            echo "Using cygpath: $WIN_PATH -> $MSYS_PATH"
          else
            # Manual conversion: D:\a\b -> /d/a/b
            DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
            PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2)
            # Convert backslashes to forward slashes: \a\b -> /a/b
            PATH_PART=$(echo "$PATH_PART" | sed 's|\\|/|g')
            # Ensure it starts with / (if it starts with backslash, convert; otherwise add /)
            if [ "${PATH_PART:0:1}" = "\\" ]; then
              PATH_PART=$(echo "$PATH_PART" | sed 's|^\\|/|')
            elif [ "${PATH_PART:0:1}" != "/" ]; then
              PATH_PART="/$PATH_PART"
            fi
            MSYS_PATH="/$DRIVE$PATH_PART"
            echo "Manual conversion: $WIN_PATH -> $MSYS_PATH"
          fi
          echo "Converting: $WIN_PATH -> $MSYS_PATH"
          cd "$MSYS_PATH" || {
            echo "Failed to cd to $MSYS_PATH"
            echo "Trying cygpath..."
            if command -v cygpath &> /dev/null; then
              MSYS_PATH=$(cygpath -u "$WIN_PATH")
              echo "cygpath result: $MSYS_PATH"
              cd "$MSYS_PATH" || exit 1
            else
              echo "ERROR: Cannot convert path $WIN_PATH"
              exit 1
            fi
          }
          echo "Current directory: $(pwd)"
          echo "Listing files:"
          ls -la
          echo "Checking for src directory:"
          ls -la src/ || echo "src directory not found!"
          mkdir -p bin obj data
          export PATH="/mingw32/bin:$PATH"
          export PKG_CONFIG_PATH="/mingw32/lib/pkgconfig"

          echo "=== Build Configuration ==="
          echo "Compiler info:"
          which gcc || echo "gcc not in PATH"
          GCC_TARGET=$(gcc -dumpmachine 2>/dev/null || echo "unknown")
          echo "Target architecture: $GCC_TARGET"

          # Verify we're using 32-bit compiler
          if [[ ! "$GCC_TARGET" == *"i686"* ]] && [[ ! "$GCC_TARGET" == *"i386"* ]]; then
            echo "WARNING: Compiler target doesn't appear to be 32-bit: $GCC_TARGET"
            echo "Attempting to use explicit 32-bit compiler..."
            if [ -f /mingw32/bin/i686-w64-mingw32-gcc.exe ]; then
              export CC="/mingw32/bin/i686-w64-mingw32-gcc.exe"
              echo "Using explicit 32-bit compiler: $CC"
            fi
          fi

          echo "pkg-config output:"
          pkg-config --cflags --libs gtk+-3.0 || echo "ERROR: pkg-config failed!"

          echo "=== Building Application ==="
          echo "Building 32-bit Windows executable..."

          # Build with explicit 32-bit flags
          # Note: -mwindows sets subsystem to Windows (GUI), GTK handles entry point conversion
          # Using -m32 explicitly ensures 32-bit build
          gcc -Wall -Wextra -std=c11 \
            -mwindows \
            -m32 \
            -o bin/stock_management.exe \
            $(pkg-config --cflags --libs gtk+-3.0) \
            src/*.c \
            -L/mingw32/lib \
            -lgtk-3 -lgdk-3 -lgobject-2.0 -lglib-2.0 -lgio-2.0 -lpango-1.0 -lcairo -lgdk_pixbuf-2.0 -latk-1.0 -lpangocairo-1.0 -lpangoft2-1.0 -lepoxy

          BUILD_EXIT_CODE=$?

          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Build failed with exit code $BUILD_EXIT_CODE"
            exit 1
          fi

          if [ ! -f bin/stock_management.exe ]; then
            echo "ERROR: Build failed - executable not created!"
            exit 1
          fi

          echo "=== Build Verification ==="
          echo "Executable created successfully!"
          ls -lh bin/stock_management.exe

          # Verify executable format
          echo "Checking executable format..."
          if command -v file &> /dev/null; then
            file bin/stock_management.exe || echo "file command failed"
          fi

          # Use objdump to verify PE format and architecture
          echo "Verifying PE format and architecture:"
          objdump -f bin/stock_management.exe 2>/dev/null | head -10 || echo "objdump failed"

          # Check if it's a valid PE file by checking magic bytes
          echo "Checking PE magic bytes..."
          HEX_MAGIC=$(head -c 2 bin/stock_management.exe | od -An -tx1 | tr -d ' \n')
          if [ "$HEX_MAGIC" = "4d5a" ] || [ "$HEX_MAGIC" = "5a4d" ]; then
            echo "✓ Valid PE magic bytes found (MZ header)"
          else
            echo "✗ WARNING: Invalid PE magic bytes: $HEX_MAGIC"
            echo "  Expected: 4d5a or 5a4d (MZ)"
          fi

          # Verify it's 32-bit by checking PE header
          echo "Checking architecture..."
          ARCH_INFO=$(objdump -f bin/stock_management.exe 2>/dev/null | grep -i "architecture" || echo "")
          if [[ "$ARCH_INFO" == *"i386"* ]] || [[ "$ARCH_INFO" == *"i686"* ]]; then
            echo "✓ Confirmed: 32-bit executable"
          else
            echo "⚠ Architecture info: $ARCH_INFO"
          fi

      - name: Bundle DLLs
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          # Convert Windows path to MSYS2 path
          WIN_PATH="${{ github.workspace }}"
          DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
          PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2 | sed 's|\\|/|g')
          if [ "${PATH_PART:0:1}" != "/" ]; then
            PATH_PART="/$PATH_PART"
          fi
          MSYS_PATH="/$DRIVE$PATH_PART"
          cd "$MSYS_PATH"
          MSYS2_BIN=/mingw32/bin

          echo "Verifying executable architecture..."
          file bin/stock_management.exe || objdump -f bin/stock_management.exe | head -5 || echo "Could not verify architecture"

          echo "Finding all DLL dependencies..."
          # Use objdump to find all DLL dependencies
          DEPENDENCIES=$(objdump -p bin/stock_management.exe 2>/dev/null | grep "DLL Name:" | sed 's/.*DLL Name: //' | sort -u || echo "")

          if [ -z "$DEPENDENCIES" ]; then
            echo "Warning: Could not extract dependencies automatically, using comprehensive manual list"
            # Comprehensive manual list as fallback (includes MinGW runtime DLLs and all Cairo DLLs)
            # Note: Includes both libtiff-5.dll and libtiff-6.dll for compatibility
            # Includes all image format libraries and compression libraries
            DEPENDENCIES="libgcc_s_dw2-1.dll libwinpthread-1.dll libgtk-3-0.dll libgdk-3-0.dll libglib-2.0-0.dll libgobject-2.0-0.dll libgio-2.0-0.dll libpango-1.0-0.dll libcairo-2.dll libcairo-gobject-2.dll libpangoft2-1.0-0.dll libpangocairo-1.0-0.dll libgdk_pixbuf-2.0-0.dll libatk-1.0-0.dll libepoxy-0.dll libintl-8.dll libiconv-2.dll libffi-8.dll libbz2-1.dll libharfbuzz-0.dll libfreetype-6.dll libfontconfig-1.dll libpng16-16.dll libjpeg-8.dll libtiff-5.dll libtiff-6.dll libpixman-1-0.dll libexpat-1.dll libzstd.dll liblzma-5.dll liblzma.dll libz-1.dll zlib1.dll libpcre2-8-0.dll libpcre2-16-0.dll libpcre2-32-0.dll libdeflate.dll libjbig-0.dll libLerc.dll libwebp-7.dll"
          fi

          echo "Direct dependencies found:"
          echo "$DEPENDENCIES"
          echo ""

          # Function to recursively find DLL dependencies
          find_dll_deps() {
            local dll_name=$1
            local deps=""
            if [ -f "$MSYS2_BIN/$dll_name" ]; then
              # Get dependencies of this DLL
              deps=$(objdump -p "$MSYS2_BIN/$dll_name" 2>/dev/null | grep "DLL Name:" | sed 's/.*DLL Name: //' | grep -v "^msvcrt.dll$" | grep -v "^kernel32.dll$" | grep -v "^user32.dll$" | grep -v "^gdi32.dll$" | sort -u || echo "")
            fi
            echo "$deps"
          }

          # Collect all DLLs to copy (direct + transitive)
          ALL_DLLS="$DEPENDENCIES"

          # Add transitive dependencies (multiple levels deep)
          echo "Finding transitive dependencies..."
          NEW_DLLS="$DEPENDENCIES"
          ITERATION=0
          MAX_ITERATIONS=3

          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            echo "  Iteration $ITERATION: Finding dependencies..."
            CURRENT_DLLS="$NEW_DLLS"
            NEW_DLLS=""
            
            for dll in $CURRENT_DLLS; do
              TRANS_DEPS=$(find_dll_deps "$dll")
              if [ -n "$TRANS_DEPS" ]; then
                for trans_dll in $TRANS_DEPS; do
                  # Check if we already have this DLL
                  if ! echo "$ALL_DLLS" | grep -q "$trans_dll"; then
                    NEW_DLLS="$NEW_DLLS $trans_dll"
                    ALL_DLLS="$ALL_DLLS $trans_dll"
                  fi
                done
              fi
            done
            
            if [ -z "$NEW_DLLS" ]; then
              echo "  No new dependencies found, stopping."
              break
            fi
            echo "  Found $(echo $NEW_DLLS | wc -w) new dependencies"
          done

          # Remove duplicates and sort
          ALL_DLLS=$(echo "$ALL_DLLS" | tr ' ' '\n' | sort -u | tr '\n' ' ')

          echo "All DLLs to copy (including transitive):"
          echo "$ALL_DLLS"
          echo ""

          # Copy all dependencies
          echo "Copying DLLs..."
          COPY_COUNT=0
          MISSING_COUNT=0
          for dll in $ALL_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && {
                echo "✓ Copied: $dll"
                COPY_COUNT=$((COPY_COUNT + 1))
              } || echo "✗ Failed: $dll"
            else
              echo "⚠ Not found: $dll (may be system DLL)"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            fi
          done

          echo ""
          echo "DLL copy summary: $COPY_COUNT copied, $MISSING_COUNT not found (may be system DLLs)"

          # Copy MinGW runtime DLLs (CRITICAL for application to run)
          echo "Copying MinGW runtime DLLs..."
          MINGW_RUNTIME_DLLS="libgcc_s_dw2-1.dll libgcc_s_seh-1.dll libstdc++-6.dll libwinpthread-1.dll"
          for dll in $MINGW_RUNTIME_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied MinGW runtime: $dll" || echo "✗ Failed to copy: $dll"
            else
              echo "⚠ MinGW runtime DLL not found: $dll (may not be needed for this build)"
            fi
          done

          # Copy compression and utility DLLs (CRITICAL - commonly missing)
          echo "Copying compression and utility DLLs..."
          COMPRESSION_DLLS="zlib1.dll libz-1.dll libbz2-1.dll liblzma-5.dll liblzma.dll libzstd.dll libdeflate.dll"
          for dll in $COMPRESSION_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied compression DLL: $dll" || echo "✗ Failed to copy: $dll"
            else
              echo "⚠ Compression DLL not found: $dll"
            fi
          done

          # Copy PCRE2 DLLs (CRITICAL - used by GLib for regex)
          echo "Copying PCRE2 DLLs..."
          PCRE2_DLLS="libpcre2-8-0.dll libpcre2-16-0.dll libpcre2-32-0.dll"
          for dll in $PCRE2_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied PCRE2 DLL: $dll" || echo "✗ Failed to copy: $dll"
            else
              echo "⚠ PCRE2 DLL not found: $dll"
            fi
          done

          # Copy TIFF DLLs (both versions for compatibility)
          echo "Copying TIFF DLLs..."
          TIFF_DLLS="libtiff-5.dll libtiff-6.dll libjbig-0.dll libLerc.dll"
          for dll in $TIFF_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied TIFF/Image DLL: $dll" || echo "✗ Failed to copy: $dll"
            else
              echo "⚠ TIFF/Image DLL not found: $dll"
            fi
          done

          # Copy JPEG DLLs (ensure all variants)
          echo "Copying JPEG DLLs..."
          JPEG_DLLS="libjpeg-8.dll libjpeg.dll"
          for dll in $JPEG_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied JPEG DLL: $dll" || echo "✗ Failed to copy: $dll"
            fi
          done

          # Copy WebP DLLs
          echo "Copying WebP DLLs..."
          WEBP_DLLS="libwebp-7.dll libwebp.dll"
          for dll in $WEBP_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied WebP DLL: $dll" || echo "✗ Failed to copy: $dll"
            fi
          done

          # Copy Pixman DLLs (CRITICAL for Cairo)
          echo "Copying Pixman DLLs..."
          PIXMAN_DLLS="libpixman-1-0.dll libpixman-1.dll"
          for dll in $PIXMAN_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied Pixman DLL: $dll" || echo "✗ Failed to copy: $dll"
            fi
          done

          # Copy all Cairo-related DLLs (CRITICAL - Cairo has multiple DLLs)
          echo "Copying all Cairo DLLs..."
          CAIRO_DLLS="libcairo-2.dll libcairo-gobject-2.dll libcairo-script-interpreter-2.dll"
          for dll in $CAIRO_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied Cairo DLL: $dll" || echo "✗ Failed: $dll"
            else
              echo "⚠ Cairo DLL not found: $dll (may not be needed)"
            fi
          done

          # Copy all Pango-related DLLs (Pango has multiple DLLs)
          echo "Copying all Pango DLLs..."
          PANGO_DLLS="libpango-1.0-0.dll libpangocairo-1.0-0.dll libpangoft2-1.0-0.dll libpangowin32-1.0-0.dll"
          for dll in $PANGO_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied Pango DLL: $dll" || echo "✗ Failed: $dll"
            fi
          done

          # Copy all GLib/GObject-related DLLs
          echo "Copying all GLib/GObject DLLs..."
          GLIB_DLLS="libglib-2.0-0.dll libgobject-2.0-0.dll libgio-2.0-0.dll libgmodule-2.0-0.dll libgthread-2.0-0.dll"
          for dll in $GLIB_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied GLib DLL: $dll" || echo "✗ Failed: $dll"
            fi
          done

          # Copy additional common DLLs that might be needed
          echo "Copying additional common DLLs..."
          ADDITIONAL_DLLS="libbrotlidec.dll libbrotlicommon.dll libgraphite2.dll libdatrie-1.dll libthai-0.dll libfribidi-0.dll"
          for dll in $ADDITIONAL_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ 2>/dev/null && echo "✓ Copied additional: $dll" || true
            fi
          done

          # Verify critical Cairo DLLs are present
          echo ""
          echo "Verifying Cairo DLLs..."
          if [ -f "bin/libcairo-2.dll" ]; then
            echo "✓ libcairo-2.dll found"
          else
            echo "✗ ERROR: libcairo-2.dll missing!"
          fi
          if [ -f "bin/libcairo-gobject-2.dll" ]; then
            echo "✓ libcairo-gobject-2.dll found"
          else
            echo "✗ ERROR: libcairo-gobject-2.dll missing!"
          fi

          # Verify compression DLLs
          echo ""
          echo "Verifying compression DLLs..."
          if [ -f "bin/zlib1.dll" ]; then
            echo "✓ zlib1.dll found"
          elif [ -f "bin/libz-1.dll" ]; then
            echo "✓ libz-1.dll found (alternative to zlib1.dll)"
            # Try to copy zlib1.dll if it exists with different name
            if [ -f "$MSYS2_BIN/zlib1.dll" ] && [ ! -f "bin/zlib1.dll" ]; then
              cp "$MSYS2_BIN/zlib1.dll" bin/ && echo "✓ Also copied zlib1.dll"
            fi
          else
            echo "✗ ERROR: zlib1.dll or libz-1.dll missing!"
          fi

          # Verify PCRE2 DLLs
          echo ""
          echo "Verifying PCRE2 DLLs..."
          if [ -f "bin/libpcre2-8-0.dll" ]; then
            echo "✓ libpcre2-8-0.dll found"
          else
            echo "✗ ERROR: libpcre2-8-0.dll missing!"
          fi

          # Verify TIFF DLLs
          echo ""
          echo "Verifying TIFF DLLs..."
          if [ -f "bin/libtiff-6.dll" ]; then
            echo "✓ libtiff-6.dll found"
          elif [ -f "bin/libtiff-5.dll" ]; then
            echo "⚠ libtiff-5.dll found (but libtiff-6.dll may be required)"
            # Try to copy libtiff-6.dll if available
            if [ -f "$MSYS2_BIN/libtiff-6.dll" ]; then
              cp "$MSYS2_BIN/libtiff-6.dll" bin/ && echo "✓ Also copied libtiff-6.dll"
            fi
          else
            echo "✗ ERROR: No TIFF DLL found!"
          fi

          # Copy any remaining DLLs matching common GTK/Cairo patterns (safety net)
          echo ""
          echo "Copying any remaining GTK/Cairo/GLib DLLs (safety net)..."
          PATTERN_DLLS=$(ls "$MSYS2_BIN"/lib{gtk,gdk,glib,gobject,gio,gmodule,gthread,cairo,pango,atk,epoxy,gdk_pixbuf}-*.dll 2>/dev/null | xargs -n1 basename 2>/dev/null || echo "")
          for dll in $PATTERN_DLLS; do
            if [ ! -f "bin/$dll" ] && [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ 2>/dev/null && echo "✓ Copied pattern match: $dll" || true
            fi
          done

          # Verify critical DLLs are present
          echo ""
          echo "Verifying MinGW runtime DLLs..."
          if [ -f "bin/libgcc_s_dw2-1.dll" ]; then
            echo "✓ libgcc_s_dw2-1.dll found (required for 32-bit builds)"
          elif [ -f "bin/libgcc_s_seh-1.dll" ]; then
            echo "✓ libgcc_s_seh-1.dll found (required for 64-bit builds)"
          else
            echo "✗ WARNING: No MinGW runtime DLL found! Application may not run."
            echo "  Attempting to find any libgcc DLL..."
            ls -la "$MSYS2_BIN"/libgcc*.dll 2>/dev/null || echo "  No libgcc DLLs found in $MSYS2_BIN"
          fi

          # Copy GTK data files
          echo "Copying GTK data files..."
          if [ -d /mingw32/share/gtk-3.0 ]; then
            mkdir -p bin/share
            cp -r /mingw32/share/gtk-3.0 bin/share/ 2>/dev/null || true
            cp -r /mingw32/share/glib-2.0 bin/share/ 2>/dev/null || true
            cp -r /mingw32/share/icons bin/share/ 2>/dev/null || true
            cp -r /mingw32/share/themes bin/share/ 2>/dev/null || true
          fi

          # Create data folder
          mkdir -p bin/data

          # Compile schemas if glib-compile-schemas exists
          if [ -f /mingw32/bin/glib-compile-schemas.exe ] && [ -d bin/share/glib-2.0/schemas ]; then
            echo "Compiling GLib schemas..."
            /mingw32/bin/glib-compile-schemas.exe bin/share/glib-2.0/schemas 2>/dev/null || true
          fi

          echo "Verifying DLLs in bin directory..."
          DLL_COUNT=$(ls -1 bin/*.dll 2>/dev/null | wc -l)
          echo "Total DLLs copied: $DLL_COUNT"

          # Comprehensive check: Find ALL DLLs required by the executable and verify they exist
          echo ""
          echo "=== Comprehensive DLL Dependency Check ==="
          EXE_DEPS=$(objdump -p bin/stock_management.exe 2>/dev/null | grep "DLL Name:" | sed 's/.*DLL Name: //' | sort -u || echo "")

          MISSING_EXE_DEPS=""
          for dep in $EXE_DEPS; do
            # Skip system DLLs
            if [[ "$dep" =~ ^(msvcrt|kernel32|user32|gdi32|advapi32|shell32|ole32|oleaut32|comctl32|comdlg32|ws2_32|ntdll|rpcrt4|sechost|shlwapi|version|winspool|imm32|winmm|usp10|dwmapi|uxtheme|dnsapi|iphlpapi|netapi32|wtsapi32|psapi|pdh|powrprof|setupapi|cfgmgr32|devobj|newdev|winusb|hid|setupapi|wininet|urlmon|winhttp|crypt32|cryptnet|bcrypt|ncrypt|wintrust|msasn1|rsaenh|gdiplus|msimg32|opengl32|glu32|d3d9|d3d11|dxgi|dinput8|xinput|dsound|winmm|msacm32|avrt|mf|mfplat|mfreadwrite|mfuuid|wmcodecdspuuid|propsys|sapi|sapi5|sapi51|sapi52|sapi53|sapi54|sapi55|sapi56|sapi57|sapi58|sapi59|sapi60|sapi61|sapi62|sapi63|sapi64|sapi65|sapi66|sapi67|sapi68|sapi69|sapi70|sapi71|sapi72|sapi73|sapi74|sapi75|sapi76|sapi77|sapi78|sapi79|sapi80|sapi81|sapi82|sapi83|sapi84|sapi85|sapi86|sapi87|sapi88|sapi89|sapi90|sapi91|sapi92|sapi93|sapi94|sapi95|sapi96|sapi97|sapi98|sapi99|sapi100)\.dll$ ]]; then
              continue
            fi
            
            if [ ! -f "bin/$dep" ]; then
              MISSING_EXE_DEPS="$MISSING_EXE_DEPS $dep"
              echo "✗ MISSING: $dep (required by executable)"
            fi
          done

          if [ -n "$MISSING_EXE_DEPS" ]; then
            echo ""
            echo "⚠ WARNING: Found missing DLLs required by executable!"
            echo "Attempting to copy missing DLLs..."
            for dep in $MISSING_EXE_DEPS; do
              if [ -f "$MSYS2_BIN/$dep" ]; then
                cp "$MSYS2_BIN/$dep" bin/ && echo "✓ Copied missing DLL: $dep" || echo "✗ Failed to copy: $dep"
              else
                echo "✗ Cannot find: $dep (may be system DLL or not available)"
              fi
            done
          else
            echo "✓ All DLLs required by executable are present!"
          fi

          # Check for common GTK-related DLLs that might be missing
          echo ""
          echo "Checking for common GTK-related DLLs..."
          COMMON_GTK_DLLS="libgailutil-3-0.dll libgtk-win32-2.0-0.dll libgtk-3-0.dll libgdk-3-0.dll libgdk-win32-2.0-0.dll"
          for dll in $COMMON_GTK_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ] && [ ! -f "bin/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ 2>/dev/null && echo "✓ Copied additional GTK DLL: $dll" || true
            fi
          done

          echo ""
          echo "DLLs copied successfully"

          # Create a dependency report for debugging
          echo ""
          echo "=== Creating Dependency Report ==="
          {
            echo "=== DLL Dependency Report ==="
            echo "Generated: $(date)"
            echo ""
            echo "Executable: bin/stock_management.exe"
            echo ""
            echo "Direct Dependencies:"
            objdump -p bin/stock_management.exe 2>/dev/null | grep "DLL Name:" | sed 's/.*DLL Name: /  - /' || echo "  (could not extract)"
            echo ""
            echo "DLLs in bin directory:"
            ls -1 bin/*.dll 2>/dev/null | xargs -n1 basename | sed 's/^/  - /' || echo "  (none found)"
          } > bin/dependency_report.txt 2>/dev/null || true
          echo "Dependency report saved to bin/dependency_report.txt"

      - name: Verify Executable and DLLs
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          WIN_PATH="${{ github.workspace }}"
          DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
          PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2 | sed 's|\\|/|g')
          if [ "${PATH_PART:0:1}" != "/" ]; then
            PATH_PART="/$PATH_PART"
          fi
          MSYS_PATH="/$DRIVE$PATH_PART"
          cd "$MSYS_PATH"

          echo "=== Verification ==="
          echo "Checking executable..."
          if [ ! -f bin/stock_management.exe ]; then
            echo "ERROR: stock_management.exe not found!"
            exit 1
          fi

          echo "Checking DLL count..."
          DLL_COUNT=$(ls bin/*.dll 2>/dev/null | wc -l)
          echo "Found $DLL_COUNT DLL files"

          if [ "$DLL_COUNT" -lt 20 ]; then
            echo "WARNING: Expected at least 20 DLLs, found only $DLL_COUNT"
          fi

          echo "Checking for critical DLLs..."
          CRITICAL_DLLS="libgcc_s_dw2-1.dll libwinpthread-1.dll libgtk-3-0.dll libglib-2.0-0.dll libgobject-2.0-0.dll libcairo-2.dll libcairo-gobject-2.dll zlib1.dll libpcre2-8-0.dll libtiff-6.dll libjpeg-8.dll libpixman-1-0.dll liblzma.dll libdeflate.dll libjbig-0.dll libLerc.dll libwebp-7.dll"
          MISSING_CRITICAL=0
          for dll in $CRITICAL_DLLS; do
            if [ -f "bin/$dll" ]; then
              echo "✓ Found: $dll"
            else
              echo "✗ Missing: $dll"
              MISSING_CRITICAL=$((MISSING_CRITICAL + 1))
            fi
          done

          if [ $MISSING_CRITICAL -gt 0 ]; then
            echo ""
            echo "⚠ WARNING: $MISSING_CRITICAL critical DLL(s) missing!"
            echo "  The application may not run without these DLLs."
          fi

          echo "Verifying executable format..."
          file bin/stock_management.exe || echo "file command not available"

          # Comprehensive DLL dependency verification
          echo "=== Final DLL Dependency Verification ==="
          EXE_REQUIRED_DLLS=$(objdump -p bin/stock_management.exe 2>/dev/null | grep "DLL Name:" | sed 's/.*DLL Name: //' | sort -u || echo "")

          MISSING_DLLS=""
          SYSTEM_DLLS="msvcrt kernel32 user32 gdi32 advapi32 shell32 ole32 oleaut32 comctl32 comdlg32 ws2_32 ntdll rpcrt4 sechost shlwapi version winspool imm32 winmm usp10 dwmapi uxtheme"

          for dll in $EXE_REQUIRED_DLLS; do
            # Check if it's a system DLL
            IS_SYSTEM=0
            for sys_dll in $SYSTEM_DLLS; do
              if [[ "$dll" == "$sys_dll.dll" ]]; then
                IS_SYSTEM=1
                break
              fi
            done
            
            if [ $IS_SYSTEM -eq 0 ] && [ ! -f "bin/$dll" ]; then
              MISSING_DLLS="$MISSING_DLLS $dll"
              echo "✗ MISSING: $dll (required by executable)"
            fi
          done

          if [ -n "$MISSING_DLLS" ]; then
            echo ""
            echo "⚠ WARNING: Found missing DLLs required by executable!"
            echo "Missing DLLs: $MISSING_DLLS"
            echo ""
            echo "Attempting to find and copy missing DLLs..."
            for dll in $MISSING_DLLS; do
              # Try to find in MSYS2 bin
              if [ -f "$MSYS2_BIN/$dll" ]; then
                cp "$MSYS2_BIN/$dll" bin/ && echo "✓ Copied: $dll" || echo "✗ Failed: $dll"
              else
                # Try to find in lib directories
                FOUND=0
                for lib_dir in /mingw32/lib /mingw32/bin; do
                  if [ -f "$lib_dir/$dll" ]; then
                    cp "$lib_dir/$dll" bin/ && echo "✓ Copied from $lib_dir: $dll" || echo "✗ Failed: $dll"
                    FOUND=1
                    break
                  fi
                done
                if [ $FOUND -eq 0 ]; then
                  echo "✗ Cannot locate: $dll"
                fi
              fi
            done
          else
            echo "✓ All non-system DLLs required by executable are present!"
          fi

          # Additional check: Verify all DLLs in bin can find their dependencies
          echo ""
          echo "Checking DLL dependencies recursively..."
          BIN_DLLS=$(ls -1 bin/*.dll 2>/dev/null | xargs -n1 basename || echo "")
          MISSING_TRANSITIVE=""

          for bin_dll in $BIN_DLLS; do
            TRANS_DEPS=$(objdump -p "bin/$bin_dll" 2>/dev/null | grep "DLL Name:" | sed 's/.*DLL Name: //' | sort -u || echo "")
            for trans_dep in $TRANS_DEPS; do
              # Skip system DLLs
              IS_SYSTEM=0
              for sys_dll in $SYSTEM_DLLS; do
                if [[ "$trans_dep" == "$sys_dll.dll" ]]; then
                  IS_SYSTEM=1
                  break
                fi
              done
              
              if [ $IS_SYSTEM -eq 0 ] && [ ! -f "bin/$trans_dep" ]; then
                # Check if we already reported this
                if ! echo "$MISSING_TRANSITIVE" | grep -q "$trans_dep"; then
                  MISSING_TRANSITIVE="$MISSING_TRANSITIVE $trans_dep"
                  echo "⚠ Transitive dependency missing: $trans_dep (required by $bin_dll)"
                fi
              fi
            done
          done

          if [ -n "$MISSING_TRANSITIVE" ]; then
            echo ""
            echo "Copying missing transitive dependencies..."
            for dep in $MISSING_TRANSITIVE; do
              if [ -f "$MSYS2_BIN/$dep" ]; then
                cp "$MSYS2_BIN/$dep" bin/ && echo "✓ Copied transitive: $dep" || echo "✗ Failed: $dep"
              fi
            done
          fi

          # Final summary
          echo ""
          echo "=== Final DLL Summary ==="
          FINAL_DLL_COUNT=$(ls -1 bin/*.dll 2>/dev/null | wc -l)
          echo "Total DLLs in bin directory: $FINAL_DLL_COUNT"
          echo ""
          echo "DLLs by category:"
          echo "  MinGW Runtime: $(ls -1 bin/libgcc*.dll bin/libwinpthread*.dll 2>/dev/null | wc -l)"
          echo "  GTK: $(ls -1 bin/libgtk*.dll bin/libgdk*.dll 2>/dev/null | wc -l)"
          echo "  GLib: $(ls -1 bin/libglib*.dll bin/libgobject*.dll bin/libgio*.dll bin/libgmodule*.dll bin/libgthread*.dll 2>/dev/null | wc -l)"
          echo "  Cairo: $(ls -1 bin/libcairo*.dll 2>/dev/null | wc -l)"
          echo "  Pango: $(ls -1 bin/libpango*.dll 2>/dev/null | wc -l)"
          echo "  Other: $(ls -1 bin/*.dll 2>/dev/null | grep -v -E "(libgcc|libwinpthread|libgtk|libgdk|libglib|libgobject|libgio|libgmodule|libgthread|libcairo|libpango)" | wc -l)"
          echo ""
          echo "All DLLs:"
          ls -1 bin/*.dll 2>/dev/null | sort

          # Verify no obvious missing DLLs by checking common patterns
          echo ""
          echo "=== Pattern-based Verification ==="
          PATTERNS_TO_CHECK="libgcc libwinpthread libgtk libgdk libglib libgobject libgio libgmodule libgthread libcairo libpango libatk libepoxy libgdk_pixbuf libintl libiconv libffi libharfbuzz libfreetype libfontconfig libpng libjpeg libtiff libpixman libexpat libz libbz2 liblzma libzstd libpcre2 libdeflate libjbig libLerc libwebp zlib"
          for pattern in $PATTERNS_TO_CHECK; do
            DLLS_WITH_PATTERN=$(ls -1 bin/${pattern}*.dll 2>/dev/null | wc -l)
            if [ "$DLLS_WITH_PATTERN" -eq 0 ]; then
              echo "⚠ No DLLs found matching pattern: $pattern"
            fi
          done

      - name: Create Standalone Package
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          WIN_PATH="${{ github.workspace }}"
          DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
          PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2- | sed 's|\\|/|g' | sed 's|^\\||')
          if [ "${PATH_PART:0:1}" != "/" ]; then
            PATH_PART="/$PATH_PART"
          fi
          MSYS_PATH="/$DRIVE$PATH_PART"
          cd "$MSYS_PATH/bin"
          mkdir -p share data

      - name: Upload Standalone Package
        uses: actions/upload-artifact@v4
        with:
          name: StockManagement-Windows-Standalone-32bit
          path: bin/*
          retention-days: 30

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          refreshenv

      - name: Verify Before Installer Creation
        shell: cmd
        run: |
          echo Verifying executable before creating installer...
          if not exist bin\stock_management.exe (
            echo ERROR: stock_management.exe not found!
            exit /b 1
          )
          echo Executable size:
          dir bin\stock_management.exe
          echo.
          echo DLL count:
          dir /b bin\*.dll | find /c ".dll"
          echo.
          echo Verifying PE format...
          powershell -Command "Get-Content bin\stock_management.exe -TotalCount 2 -Encoding Byte | ForEach-Object { '{0:X2}' -f $_ }"
          echo.
          echo Checking for MinGW runtime DLLs...
          if exist bin\libgcc_s_dw2-1.dll (
            echo [OK] libgcc_s_dw2-1.dll found
          ) else (
            echo [ERROR] libgcc_s_dw2-1.dll MISSING - Application will not run!
          )
          if exist bin\libwinpthread-1.dll (
            echo [OK] libwinpthread-1.dll found
          ) else (
            echo [WARN] libwinpthread-1.dll missing
          )
          echo.
          echo Checking for Cairo DLLs...
          if exist bin\libcairo-2.dll (
            echo [OK] libcairo-2.dll found
          ) else (
            echo [ERROR] libcairo-2.dll MISSING!
          )
          if exist bin\libcairo-gobject-2.dll (
            echo [OK] libcairo-gobject-2.dll found
          ) else (
            echo [ERROR] libcairo-gobject-2.dll MISSING - Application will not run!
          )
          echo.
          echo Checking for compression and utility DLLs...
          if exist bin\zlib1.dll (
            echo [OK] zlib1.dll found
          ) else (
            echo [ERROR] zlib1.dll MISSING - Application will not run!
          )
          if exist bin\libpcre2-8-0.dll (
            echo [OK] libpcre2-8-0.dll found
          ) else (
            echo [ERROR] libpcre2-8-0.dll MISSING - Application will not run!
          )
          if exist bin\libtiff-6.dll (
            echo [OK] libtiff-6.dll found
          ) else if exist bin\libtiff-5.dll (
            echo [OK] libtiff-5.dll found ^(libtiff-6.dll not found, but libtiff-5.dll present^)
          ) else (
            echo [ERROR] libtiff DLL MISSING - Application may not run!
          )
          echo.
          echo Checking for image format DLLs...
          if exist bin\libjpeg-8.dll (
            echo [OK] libjpeg-8.dll found
          ) else (
            echo [ERROR] libjpeg-8.dll MISSING - Application will not run!
          )
          if exist bin\libpixman-1-0.dll (
            echo [OK] libpixman-1-0.dll found
          ) else (
            echo [ERROR] libpixman-1-0.dll MISSING - Application will not run!
          )
          if exist bin\liblzma.dll (
            echo [OK] liblzma.dll found
          ) else if exist bin\liblzma-5.dll (
            echo [OK] liblzma-5.dll found ^(liblzma.dll not found, but liblzma-5.dll present^)
          ) else (
            echo [ERROR] liblzma DLL MISSING - Application may not run!
          )
          if exist bin\libdeflate.dll (
            echo [OK] libdeflate.dll found
          ) else (
            echo [ERROR] libdeflate.dll MISSING - Application will not run!
          )
          if exist bin\libjbig-0.dll (
            echo [OK] libjbig-0.dll found
          ) else (
            echo [ERROR] libjbig-0.dll MISSING - Application will not run!
          )
          if exist bin\libLerc.dll (
            echo [OK] libLerc.dll found
          ) else (
            echo [ERROR] libLerc.dll MISSING - Application will not run!
          )
          if exist bin\libwebp-7.dll (
            echo [OK] libwebp-7.dll found
          ) else (
            echo [ERROR] libwebp-7.dll MISSING - Application will not run!
          )

      - name: Create Installer
        shell: cmd
        run: |
          if exist StockManagement_Installer_WithGTK.iss (
            "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" StockManagement_Installer_WithGTK.iss
          ) else if exist StockManagement_Installer.iss (
            "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" StockManagement_Installer.iss
          )

      - name: Verify Installer Contents
        shell: cmd
        run: |
          echo Verifying installer was created...
          if exist installer\*.exe (
            echo Installer created successfully
            dir installer\*.exe
          ) else (
            echo WARNING: No installer found in installer directory
          )

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: StockManagement-Installer-32bit
          path: installer/*.exe
          retention-days: 30
          if-no-files-found: warn
