name: Build Windows Executable

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MSYS2
        run: |
          choco install msys2 -y
          refreshenv

      - name: Install GTK and Build Tools
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm mingw-w64-x86_64-gtk3 mingw-w64-x86_64-pkg-config mingw-w64-x86_64-gcc make

      - name: Build Application
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          # Convert Windows path D:\a\cguiapp\cguiapp to /d/a/cguiapp/cguiapp
          WIN_PATH="${{ github.workspace }}"
          # Convert Windows path: D:\a\cguiapp\cguiapp -> /d/a/cguiapp/cguiapp
          # Try cygpath first (most reliable)
          if command -v cygpath &> /dev/null; then
            MSYS_PATH=$(cygpath -u "$WIN_PATH")
            echo "Using cygpath: $WIN_PATH -> $MSYS_PATH"
          else
            # Manual conversion: D:\a\b -> /d/a/b
            DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
            PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2)
            # Convert backslashes to forward slashes: \a\b -> /a/b
            PATH_PART=$(echo "$PATH_PART" | sed 's|\\|/|g')
            # Ensure it starts with / (if it starts with backslash, convert; otherwise add /)
            if [ "${PATH_PART:0:1}" = "\\" ]; then
              PATH_PART=$(echo "$PATH_PART" | sed 's|^\\|/|')
            elif [ "${PATH_PART:0:1}" != "/" ]; then
              PATH_PART="/$PATH_PART"
            fi
            MSYS_PATH="/$DRIVE$PATH_PART"
            echo "Manual conversion: $WIN_PATH -> $MSYS_PATH"
          fi
          echo "Converting: $WIN_PATH -> $MSYS_PATH"
          cd "$MSYS_PATH" || {
            echo "Failed to cd to $MSYS_PATH"
            echo "Trying cygpath..."
            if command -v cygpath &> /dev/null; then
              MSYS_PATH=$(cygpath -u "$WIN_PATH")
              echo "cygpath result: $MSYS_PATH"
              cd "$MSYS_PATH" || exit 1
            else
              echo "ERROR: Cannot convert path $WIN_PATH"
              exit 1
            fi
          }
          echo "Current directory: $(pwd)"
          echo "Listing files:"
          ls -la
          echo "Checking for src directory:"
          ls -la src/ || echo "src directory not found!"
          mkdir -p bin obj data
          export PATH="/mingw64/bin:$PATH"
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig"
          echo "Building application..."
          echo "Compiler info:"
          which gcc || echo "gcc not in PATH"
          gcc -v 2>&1 | head -3 || true
          echo "Target architecture:"
          gcc -dumpmachine || echo "Could not determine target"
          echo "pkg-config output:"
          pkg-config --cflags --libs gtk+-3.0
          echo "Building 64-bit executable..."
          gcc -Wall -Wextra -std=c11 -mwindows \
            -o bin/stock_management.exe \
            $(pkg-config --cflags --libs gtk+-3.0) \
            src/*.c \
            -L/mingw64/lib \
            -lgtk-3 -lgdk-3 -lgobject-2.0 -lglib-2.0 -lgio-2.0 -lpango-1.0 -lcairo -lgdk_pixbuf-2.0 -latk-1.0 -lpangocairo-1.0 -lpangoft2-1.0 -lepoxy
          
          if [ ! -f bin/stock_management.exe ]; then
            echo "ERROR: Build failed - executable not created!"
            exit 1
          fi
          
          echo "Build successful! Verifying executable..."
          ls -lh bin/stock_management.exe
          echo "Checking executable type:"
          file bin/stock_management.exe || objdump -f bin/stock_management.exe | head -3 || echo "Could not verify executable format"

      - name: Bundle DLLs
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          # Convert Windows path to MSYS2 path
          WIN_PATH="${{ github.workspace }}"
          DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
          PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2 | sed 's|\\|/|g')
          if [ "${PATH_PART:0:1}" != "/" ]; then
            PATH_PART="/$PATH_PART"
          fi
          MSYS_PATH="/$DRIVE$PATH_PART"
          cd "$MSYS_PATH"
          MSYS2_BIN=/mingw64/bin

          echo "Verifying executable architecture..."
          file bin/stock_management.exe || objdump -f bin/stock_management.exe | head -5 || echo "Could not verify architecture"

          echo "Finding all DLL dependencies..."
          # Use objdump to find all DLL dependencies
          DEPENDENCIES=$(objdump -p bin/stock_management.exe 2>/dev/null | grep "DLL Name:" | sed 's/.*DLL Name: //' | sort -u || echo "")
          
          if [ -z "$DEPENDENCIES" ]; then
            echo "Warning: Could not extract dependencies automatically, using manual list"
            # Manual list as fallback
            DEPENDENCIES="libgtk-3-0.dll libgdk-3-0.dll libglib-2.0-0.dll libgobject-2.0-0.dll libgio-2.0-0.dll libpango-1.0-0.dll libcairo-2.dll libpangoft2-1.0-0.dll libpangocairo-1.0-0.dll libgdk_pixbuf-2.0-0.dll libatk-1.0-0.dll libepoxy-0.dll libintl-8.dll libiconv-2.dll libwinpthread-1.dll libffi-8.dll libbz2-1.dll libharfbuzz-0.dll libfreetype-6.dll libfontconfig-1.dll libpng16-16.dll libjpeg-8.dll libtiff-5.dll libpixman-1-0.dll libexpat-1.dll libzstd.dll liblzma-5.dll libz-1.dll"
          fi

          echo "Dependencies found:"
          echo "$DEPENDENCIES"

          # Copy all dependencies recursively
          echo "Copying DLLs..."
          for dll in $DEPENDENCIES; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ && echo "Copied: $dll" || echo "Failed: $dll"
            else
              echo "Warning: $dll not found in $MSYS2_BIN"
            fi
          done

          # Copy additional common DLLs that might be needed
          ADDITIONAL_DLLS="libzstd.dll liblzma-5.dll libz-1.dll libbrotlidec.dll libbrotlicommon.dll libgraphite2.dll libdatrie-1.dll libthai-0.dll"
          for dll in $ADDITIONAL_DLLS; do
            if [ -f "$MSYS2_BIN/$dll" ]; then
              cp "$MSYS2_BIN/$dll" bin/ 2>/dev/null || true
            fi
          done

          # Copy GTK data files
          echo "Copying GTK data files..."
          if [ -d /mingw64/share/gtk-3.0 ]; then
            mkdir -p bin/share
            cp -r /mingw64/share/gtk-3.0 bin/share/ 2>/dev/null || true
            cp -r /mingw64/share/glib-2.0 bin/share/ 2>/dev/null || true
            cp -r /mingw64/share/icons bin/share/ 2>/dev/null || true
            cp -r /mingw64/share/themes bin/share/ 2>/dev/null || true
          fi

          # Create data folder
          mkdir -p bin/data

          # Compile schemas if glib-compile-schemas exists
          if [ -f /mingw64/bin/glib-compile-schemas.exe ] && [ -d bin/share/glib-2.0/schemas ]; then
            echo "Compiling GLib schemas..."
            /mingw64/bin/glib-compile-schemas.exe bin/share/glib-2.0/schemas 2>/dev/null || true
          fi

          echo "Verifying DLLs in bin directory..."
          ls -la bin/*.dll | wc -l
          echo "DLLs copied successfully"

      - name: Verify Executable and DLLs
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          WIN_PATH="${{ github.workspace }}"
          DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
          PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2 | sed 's|\\|/|g')
          if [ "${PATH_PART:0:1}" != "/" ]; then
            PATH_PART="/$PATH_PART"
          fi
          MSYS_PATH="/$DRIVE$PATH_PART"
          cd "$MSYS_PATH"

          echo "=== Verification ==="
          echo "Checking executable..."
          if [ ! -f bin/stock_management.exe ]; then
            echo "ERROR: stock_management.exe not found!"
            exit 1
          fi

          echo "Checking DLL count..."
          DLL_COUNT=$(ls bin/*.dll 2>/dev/null | wc -l)
          echo "Found $DLL_COUNT DLL files"

          if [ "$DLL_COUNT" -lt 20 ]; then
            echo "WARNING: Expected at least 20 DLLs, found only $DLL_COUNT"
          fi

          echo "Checking for critical DLLs..."
          CRITICAL_DLLS="libgtk-3-0.dll libglib-2.0-0.dll libgobject-2.0-0.dll"
          for dll in $CRITICAL_DLLS; do
            if [ -f "bin/$dll" ]; then
              echo "✓ Found: $dll"
            else
              echo "✗ Missing: $dll"
            fi
          done

          echo "Verifying executable format..."
          file bin/stock_management.exe || echo "file command not available"

      - name: Create Standalone Package
        shell: C:\tools\msys64\usr\bin\bash.exe -l {0}
        run: |
          WIN_PATH="${{ github.workspace }}"
          DRIVE=$(echo "$WIN_PATH" | cut -d: -f1 | tr '[:upper:]' '[:lower:]')
          PATH_PART=$(echo "$WIN_PATH" | cut -d: -f2- | sed 's|\\|/|g' | sed 's|^\\||')
          if [ "${PATH_PART:0:1}" != "/" ]; then
            PATH_PART="/$PATH_PART"
          fi
          MSYS_PATH="/$DRIVE$PATH_PART"
          cd "$MSYS_PATH/bin"
          mkdir -p share data

      - name: Upload Standalone Package
        uses: actions/upload-artifact@v4
        with:
          name: StockManagement-Windows-Standalone
          path: bin/*
          retention-days: 30

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          refreshenv

      - name: Create Installer
        shell: cmd
        run: |
          if exist StockManagement_Installer_WithGTK.iss (
            "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" StockManagement_Installer_WithGTK.iss
          ) else if exist StockManagement_Installer.iss (
            "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" StockManagement_Installer.iss
          )

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: StockManagement-Installer
          path: installer/*.exe
          retention-days: 30
          if-no-files-found: warn
